$(document).ready(function () {
    function updateFormValue() {
        if (localStorage.getItem('formData') != null) {
            let formData = JSON.parse(localStorage.getItem('formData'));
            for (const input of formData) {
                $(`[name="` + input.name + `"]`).val(input.value);
            }
        }
    };
    updateFormValue();

    $('form.contact-form-hubspot').submit(function (e) {
        e.preventDefault();
        var form = $(this);
        let formArray = form.serializeArray();

        // Create the new request
        var xhr = new XMLHttpRequest();

        // 	portalId: "8457944",
        // 	formId: "88ae4433-09b1-44d5-8ced-430dfa76d4c7"
        // var url = 'https://api.hsforms.com/submissions/v3/integration/submit/8457944/88ae4433-09b1-44d5-8ced-430dfa76d4c7';
        var url = 'https://pi.pardot.com/api/v5/objects/form-handler-fields'

        // request JSON:
        var data = {
            "fields": formArray
        }

        var final_data = JSON.stringify(data)

        xhr.open('POST', url);
        // Sets the value of the 'Content-Type' HTTP request headers to 'application/json'
        xhr.setRequestHeader('Content-Type', 'application/json');

        form.find('.resp-messages').text('');

        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4 && xhr.status == 200) {
                localStorage.setItem('formData', JSON.stringify(formArray));
                let resp = JSON.parse(xhr.responseText);
                form.find('.resp-messages').append('<p style="text-align: center;">Thank you for your interest! We will be in touch soon!</p>');
                gtag_report_conversion();
                setTimeout(function () {
                    $('#info_modal').modal('hide');
                    $('#info_modal_from_hero').modal('hide');
                }, 2000);

                if (form.hasClass('popup-contact-form-hubspot')) {
                    let href = $('.btn-download-popup').attr("href");
                    console.log(href);
                    if (href != '#') {
                        window.open(href, "_blank");
                    }
                }
                // Returns a 200 response if the submission is successful.
            } else if (xhr.readyState == 4 && xhr.status == 400) {
                let respError = JSON.parse(xhr.responseText);
                console.log(respError.errors)
                form.find('.resp-messages').html('');
                for (let error of respError.errors) {
                    form.find('.resp-messages').append('<p>' + error.message + '</p>');
                }
                // Returns a 400 error the submission is rejected.
            } else if (xhr.readyState == 4 && xhr.status == 403) {
                console.log('403');
                console.log(xhr.responseText); // Returns a 403 error if the portal isn't allowed to post submissions.
            } else if (xhr.readyState == 4 && xhr.status == 404) {
                console.log('404');
                console.log(xhr.responseText); //Returns a 404 error if the formGuid isn't found
            }
        }
        // Sends the request
        xhr.send(final_data);
    });

    let trade_video = ['W-VHhCeAOXI', 'StJWkV2yZQM', '', '']
    $('.products .rth').prepend('<span class="arrow_content"></span>');


    let tradeNavItems = $('.trade-nav .trade-nav-item');
    tradeNavItems.click(function () {
        tradeNavItems.removeClass('active');
        $(this).addClass('active');
        let tradeValue = $(this).attr('trade');

        $('.trade_descrip, .trades table').addClass('display_none');
        $('#trade_video').addClass('display_none');
        $('#trade_video .video-wrap').addClass('display_none');

        if ($(window).width() <= 768 && $(this).val() != 'gc') {
            $('.mobile-info').show();
        } else {
            $('.mobile-info').hide();
        }
        $('.' + tradeValue).removeClass('display_none');
        $('#trade_video').removeClass('display_none');

        document.getElementById('trade-selected-content').scrollIntoView({
            behavior: 'smooth'
        });
    });


    $('.products .nav_block').click(function () {
        $('.products .nav_block').find('.arrow_content').remove()
        $('.products .nav_block').find('p').removeClass('active_selected')
        $('.products .product_content').addClass('display_none')
        if ($(this).hasClass('rth')) {
            $(this).prepend('<span class="arrow_content"></span>');
            $(this).find('p').addClass('active_selected');
            $('#rth').removeClass('display_none');
        } else if ($(this).hasClass('hth')) {
            $(this).prepend('<span class="arrow_content"></span>');
            $(this).find('p').addClass('active_selected');
            $('#hth').removeClass('display_none');
        } else if ($(this).hasClass('th')) {
            $(this).prepend('<span class="arrow_content"></span>');
            $(this).find('p').addClass('active_selected');
            $('#th').removeClass('display_none');
        } else if ($(this).hasClass('attachments')) {
            $(this).prepend('<span class="arrow_content"></span>');
            $(this).find('p').addClass('active_selected');
            $('#attachments').removeClass('display_none');
        }
    })

    $('.products .product_content .btn:not(.btn-contact-popup-open)').click(function (e) {
        let href = $(this).attr('href');
        $('.btn-download-popup').attr('href', href);
        if (localStorage.getItem('formData') == null) {
            e.preventDefault();
            showContactPopup();
        }
    });

    $('.btn-contact-popup-open').click(function (e) {
        e.preventDefault();
        $('.btn-download-popup').attr('href', '#');
        showContactPopup();
    });

    $('#open-hero-modal').click(function (e) {
        $('.resp-messages').html('');
        $('#info_modal_from_hero').modal();
    });

    function showContactPopup() {
        let modelName = $(this).parent().parent().find('.block_title').text();
        $('input[name="model"]').val(modelName);
        $('.resp-messages').html('');
        $('#info_modal').modal();
    }

    function getCookie(name) {
        var dc = document.cookie;
        var prefix = name + "=";
        var begin = dc.indexOf("; " + prefix);
        if (begin == -1) {
            begin = dc.indexOf(prefix);
            if (begin != 0) return null;
        } else {
            begin += 2;
            var end = document.cookie.indexOf(";", begin);
            if (end == -1) {
                end = dc.length;
            }
        }
        // because unescape has been deprecated, replaced with decodeURI
        //return unescape(dc.substring(begin + prefix.length, end));
        return decodeURI(dc.substring(begin + prefix.length, end));
    }

    function doSomething() {
        var myCookie = getCookie("MyCookie");

        if (myCookie == null) {
            // do cookie doesn't exist stuff;
        } else {
            // do cookie exists stuff
        }
    }

    window.onVidyardAPI = (vidyardEmbed) => {
        vidyardEmbed.api.addReadyListener((_, player) => {
            // console.log('player ready:', player.ready());
            // console.log(player.uuid);
            let topVideo = VidyardV4.api.getPlayersByUUID('GhTdhifEtE39DasKhBAvzQ');
            $('.custom-play-button').click(function () {
                $('.video-popup').css('display', 'flex');
                topVideo[0].play();
            });
            $('.video-popup .close').click(function () {
                $('.video-popup').hide();
                topVideo[0].pause();
            });
            // close after finished
            topVideo[0].on("playerComplete", function () {
                $('.video-popup').hide();
            });
        }, );
    }

    $(function () {
        $("#nav-icon, #nav-close").on("click", function (e) {
            $(".navbar-nav").toggleClass("open");
            e.stopPropagation();
        });
        $(document).on("click", function (e) {
            if ($(e.target).is(".navbar-nav") === false && !$(e.target).parents('.navbar-nav').length == 1) {
                $(".navbar-nav").removeClass("open");
            }
        });
    });

    $('.logo-white').mouseenter(function () {
        $('.logo-white').hide()
        $('.logo-dark').show()
    })

    $('.logo-dark').mouseleave(function () {
        $('.logo-white').show()
        $('.logo-dark').hide()
    })
});